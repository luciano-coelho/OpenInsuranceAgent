# .github/workflows/pr-code-review.yml
name: Revis√£o de C√≥digo com IA

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  # Job 1: Sanitizar o Diff (O "Guarda-Costas")
  sanitize-diff:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      # Exp√µe o nome do artefato para os pr√≥ximos jobs
      artifact-name: "sanitized-diff-${{ github.run_id }}"
    steps:
      - name: Checkout (Completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calcular e Sanatizar Diff
        run: |
          DIFF_CONTENT=$(git diff origin/${{ github.base_ref }}...${{ github.head_ref }})
          
          # Aqui voc√™ colocaria seu script de Regex (sed/awk/python)
          # Por enquanto, vamos apenas passar adiante
          SANITIZED_DIFF="$DIFF_CONTENT" 
          
          echo "$SANITIZED_DIFF" > sanitized_diff.txt

      - name: Upload do Diff Sanitizado
        uses: actions/upload-artifact@v4
        with:
          name: "sanitized-diff-${{ github.run_id }}"
          path: sanitized_diff.txt

  # Job 2: Rodar Especialistas (O "Comit√™" - em paralelo)
  run-specialists:
    runs-on: ubuntu-latest
    needs: sanitize-diff # Depende do Job 1
    
    # Estrat√©gia de Matriz: Roda este job N vezes, uma para cada item
    strategy:
      matrix:
        persona: [linter, logic, security] # Nossos 3 especialistas

    steps:
      - name: Chamar Especialista Reutiliz√°vel (${{ matrix.persona }})
        id: analysis
        uses: ./.github/workflows/reusable-ai-specialist.yml
        with:
          persona: ${{ matrix.persona }}
          diff-artifact-name: ${{ needs.sanitize-diff.outputs.artifact-name }}
      
      # Cada especialista salva seu resultado em um artefato separado
      - name: Salvar resultado (${{ matrix.persona }})
        uses: actions/upload-artifact@v4
        with:
          name: "result-${{ matrix.persona }}-${{ github.run_id }}"
          path: |
            ${{ steps.analysis.outputs.analysis-result }}
        # Truque: O path aqui est√° usando o output direto, 
        # mas uma forma mais robusta √© salvar o output em um arquivo
        # e fazer upload do arquivo. 
        # Vamos simplificar por enquanto. (Corre√ß√£o abaixo)

# --- CORRE√á√ÉO DO PASSO ACIMA ---
# O upload-artifact espera um ARQUIVO. O 'id: analysis' n√£o cria um arquivo.
# Precisamos adicionar um passo para criar o arquivo primeiro.

# (Substitua o 'run-specialists' acima por este)

  run-specialists:
    runs-on: ubuntu-latest
    needs: sanitize-diff
    strategy:
      matrix:
        persona: [linter, logic, security]
    steps:
      - name: Chamar Especialista Reutiliz√°vel (${{ matrix.persona }})
        id: analysis
        uses: ./.github/workflows/reusable-ai-specialist.yml
        with:
          persona: ${{ matrix.persona }}
          diff-artifact-name: ${{ needs.sanitize-diff.outputs.artifact-name }}
      
      - name: Salvar resultado em arquivo
        run: |
          echo "${{ steps.analysis.outputs.analysis-result }}" > "result-${{ matrix.persona }}.txt"

      - name: Upload do Resultado (${{ matrix.persona }})
        uses: actions/upload-artifact@v4
        with:
          name: "result-${{ matrix.persona }}-${{ github.run_id }}"
          path: "result-${{ matrix.persona }}.txt"

  # Job 3: Publicar Coment√°rio (O "Porta-Voz")
  publish-comment:
    runs-on: ubuntu-latest
    needs: run-specialists # Roda AP√ìS todos os especialistas terminarem
    permissions:
      pull-requests: write # Permiss√£o para comentar
      contents: read
    steps:
      - name: Download de todos os resultados
        uses: actions/download-artifact@v4
        with:
          # Baixa todos os artefatos que come√ßam com "result-"
          pattern: result-*-${{ github.run_id }}
          path: ./all-results

      - name: Compilar Coment√°rio Final
        id: compile
        run: |
          BODY="## ü§ñ Revis√£o Completa da IA\n\n"
          
          if [ -f ./all-results/result-linter-${{ github.run_id }}/result-linter.txt ]; then
            BODY="$BODY\n### üìù An√°lise de Padr√µes (Linter)\n"
            BODY="$BODY$(cat ./all-results/result-linter-${{ github.run_id }}/result-linter.txt)"
          fi
          
          if [ -f ./all-results/result-logic-${{ github.run_id }}/result-logic.txt ]; then
            BODY="$BODY\n\n### üß† An√°lise de L√≥gica\n"
            BODY="$BODY$(cat ./all-results/result-logic-${{ github.run_id }}/result-logic.txt)"
          fi
          
          if [ -f ./all-results/result-security-${{ github.run_id }}/result-security.txt ]; then
            BODY="$BODY\n\n### üõ°Ô∏è An√°lise de Seguran√ßa\n"
            BODY="$BODY$(cat ./all-results/result-security-${{ github.run_id }}/result-security.txt)"
          fi

          # Salva o corpo final para o pr√≥ximo passo
          echo "comment_body<<EOF" >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Postar Coment√°rio √önico
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.comment_body;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });