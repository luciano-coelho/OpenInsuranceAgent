name: Revisão de Código com IA

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  # Job 1: Sanitizar o Diff
  sanitize-diff:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      artifact-name: "sanitized-diff-${{ github.run_id }}"
    steps:
      - name: Checkout (Completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calcular e Sanitizar Diff
        run: |
          DIFF_CONTENT=$(git diff origin/${{ github.base_ref }}...HEAD)
          
          SANITIZED_DIFF="$DIFF_CONTENT" 
          
          echo "$SANITIZED_DIFF" > sanitized_diff.txt

      - name: Upload do Diff Sanitizado
        uses: actions/upload-artifact@v4
        with:
          name: "sanitized-diff-${{ github.run_id }}"
          path: sanitized_diff.txt

  # Job 2: Rodar Especialistas
  run-specialists:
    needs: sanitize-diff
    strategy:
      matrix:
        persona: [linter, logic, security]
    uses: ./.github/workflows/reusable-ai-specialist.yml
    with:
      persona: ${{ matrix.persona }}
      diff-artifact-name: ${{ needs.sanitize-diff.outputs.artifact-name }}
    secrets: inherit

  # Job 3: Publicar Comentário
  publish-comment:
    runs-on: ubuntu-latest
    needs: run-specialists 
    permissions:
      pull-requests: write 
      contents: read
    steps:
      - name: Download de todos os resultados
        uses: actions/download-artifact@v4
        with:
          pattern: result-*-${{ github.run_id }}
          path: ./all-results

      - name: Compilar Comentário Final
        id: compile
        run: |
          # Cria arquivo temporário para montar o comentário
          cat > comment.md <<'HEADER'
          ## Revisão Completa do Especialista
          
          HEADER
          
          if [ -f ./all-results/result-linter-${{ github.run_id }}/result-linter.txt ]; then
            echo "### Análise de Padrões (Linter)" >> comment.md
            cat ./all-results/result-linter-${{ github.run_id }}/result-linter.txt >> comment.md
            echo "" >> comment.md
          fi
          
          if [ -f ./all-results/result-logic-${{ github.run_id }}/result-logic.txt ]; then
            echo "" >> comment.md
            echo "### Análise de Lógica" >> comment.md
            cat ./all-results/result-logic-${{ github.run_id }}/result-logic.txt >> comment.md
            echo "" >> comment.md
          fi
          
          if [ -f ./all-results/result-security-${{ github.run_id }}/result-security.txt ]; then
            echo "" >> comment.md
            echo "### Análise de Segurança" >> comment.md
            cat ./all-results/result-security-${{ github.run_id }}/result-security.txt >> comment.md
          fi

          # Salva o corpo final para o próximo passo usando heredoc
          {
            echo "comment_body<<EOF"
            cat comment.md
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Postar Comentário Único
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.comment_body;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });