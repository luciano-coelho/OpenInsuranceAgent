name: Auditoria de Testes com IA (Groq)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai_test_auditor:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Passo 3: Instalar as dependências (agora vai instalar 'groq')
      - name: Instalar Dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Passo 4: Calcular o Diff do PR
      - name: Calcular Diff do PR
        id: get_diff
        run: |
          DIFF_CONTENT=$(git diff origin/${{ github.base_ref }}...HEAD)          
          TRUNCATED_DIFF=$(echo "$DIFF_CONTENT" | head -c 15000)
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$TRUNCATED_DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Passo 5: Executar o Script de Análise de IA
      - name: Chamar API do Groq para Análise
        id: ai_analysis
        env:
          # *** MUDANÇA IMPORTANTE AQUI ***
          # Passa o Secret do Groq para o script Python
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          RESPONSE=$(python .github/scripts/call_ai_model.py)
          echo "AI_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Passo 6: Postar a Análise como Comentário no PR
      - name: Postar Análise no PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const aiResponse = process.env.AI_RESPONSE;
            if (!aiResponse || aiResponse.trim() === "Diff vazio ou não fornecido.") {
              console.log("Sem resposta da IA, pulando comentário.");
              return;
            }
            const body = `### Auditoria de Testes (IA via Groq)\n\n${aiResponse}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });